#!/usr/bin/env node

/**
 * ng-alain å°ˆæ¡ˆçµæ§‹æ¨¹ç‹€åœ–ç”Ÿæˆè…³æœ¬ï¼ˆç²¾ç°¡ç‰ˆï¼‰
 * ç”Ÿæˆå…©ä»½æ–‡ä»¶ + Lint å ±å‘Šï¼š
 * 1. ng-alain-structure-folders.md - åªæœ‰è³‡æ–™å¤¾çµæ§‹
 * 2. ng-alain-structure-full.md - å®Œæ•´çµæ§‹ï¼ˆå«æ–‡ä»¶ï¼‰
 * 3. ng-alain-lint-error.md - ESLint + Stylelint å ±å‘Š
 * 4. ng-alain-lint-error-style.md - Stylelint ç¨ç«‹å ±å‘Š
 */

import { execSync } from 'node:child_process';
import * as fs from 'node:fs';
import * as path from 'node:path';

// ============================================================
// é¡å‹å®šç¾©
// ============================================================

interface LintResult {
  success: boolean;
  output: string;
  errors: string;
}

interface ProjectStats {
  files: number;
  folders: number;
}

interface TreeResult {
  tree: string;
  stats: ProjectStats;
}

// ============================================================
// å¸¸æ•¸å®šç¾©
// ============================================================

const EXCLUDE_PATTERNS: readonly string[] = [
  'dist',
  '.angular',
  'node_modules',
  '.git',
  '.vscode',
  '.idea',
  'coverage',
  '__tests__',
  'e2e',
  '.eslintcache',
  '.stylelintcache',
  '*.log',
  '*.tmp',
  '.DS_Store',
  '.env*',
  '_cli-tpl',
  '.cursor',
  '.github',
  '.husky',
  '.yarn',
  'scripts'
] as const;

const EXCLUDE_EXTENSIONS: readonly string[] = ['.map', '.spec.ts', '.spec.js', '.log', '.tmp', '.swp', '.bak'] as const;

// ============================================================
// æ ¸å¿ƒå·¥å…·å‡½æ•¸
// ============================================================

function shouldExclude(filePath: string, fileName: string): boolean {
  for (const pattern of EXCLUDE_PATTERNS) {
    if (pattern.includes('*')) {
      const regex = new RegExp(pattern.replace(/\*/g, '.*'));
      if (regex.test(fileName)) return true;
    } else {
      if (fileName === pattern || filePath.split(path.sep).includes(pattern)) return true;
    }
  }
  return EXCLUDE_EXTENSIONS.includes(path.extname(fileName));
}

function generateTreeWithStats(dirPath: string, prefix = '', isLast = true, depth = 0, maxDepth = 10, foldersOnly = false): TreeResult {
  const stats: ProjectStats = { files: 0, folders: 0 };

  if (depth > maxDepth) {
    return { tree: `${prefix + (isLast ? 'â””â”€â”€ ' : 'â”œâ”€â”€ ')}...\n`, stats };
  }

  let result = '';
  let items: fs.Dirent[] = [];

  try {
    items = fs.readdirSync(dirPath, { withFileTypes: true }).filter((item: fs.Dirent) => {
      if (shouldExclude(path.join(dirPath, item.name), item.name)) return false;
      if (foldersOnly && !item.isDirectory()) return false;
      return true;
    });
  } catch {
    return { tree: result, stats };
  }

  items.sort((a: fs.Dirent, b: fs.Dirent) => {
    if (a.isDirectory() && !b.isDirectory()) return -1;
    if (!a.isDirectory() && b.isDirectory()) return 1;
    return a.name.localeCompare(b.name);
  });

  items.forEach((item: fs.Dirent, index: number) => {
    const isLastItem = index === items.length - 1;
    const currentPrefix = isLast ? 'â””â”€â”€ ' : 'â”œâ”€â”€ ';
    const nextPrefix = isLast ? '    ' : 'â”‚   ';

    result += `${prefix}${currentPrefix}${item.name}`;

    if (item.isDirectory()) {
      result += '/\n';
      stats.folders++;
      const subPath = path.join(dirPath, item.name);
      const subResult = generateTreeWithStats(subPath, prefix + nextPrefix, isLastItem, depth + 1, maxDepth, foldersOnly);
      result += subResult.tree;
      stats.files += subResult.stats.files;
      stats.folders += subResult.stats.folders;
    } else {
      result += '\n';
      stats.files++;
    }
  });

  return { tree: result, stats };
}

function generateMarkdown(tree: string, title: string, description: string, stats: ProjectStats): string {
  const timestamp = new Date().toISOString().split('T')[0];
  return `# ${title}

> ${description}

**ç”Ÿæˆæ™‚é–“**: ${timestamp}

## ğŸ“Š çµ±è¨ˆè³‡è¨Š

- **ç›®éŒ„ç¸½æ•¸**: ${stats.folders}
${stats.files > 0 ? `- **æ–‡ä»¶ç¸½æ•¸**: ${stats.files}` : ''}

## ğŸ“‚ ç›®éŒ„çµæ§‹

\`\`\`
${tree.trim()}
\`\`\`

---

*Generated by ng-alain Structure Generator (Optimized)*
`;
}

function generateLintMarkdown(tsResult: LintResult, styleResult: LintResult): string {
  const timestamp = new Date().toISOString().replace('T', ' ').substring(0, 19);
  const tsErrors = (tsResult.output.match(/âœ– \d+ problem/g) || [])[0] || 'ç„¡éŒ¯èª¤';
  const styleErrors = (styleResult.output.match(/âœ– \d+ problem/g) || [])[0] || 'ç„¡éŒ¯èª¤';

  return `# ğŸ“‹ ng-alain Lint éŒ¯èª¤å ±å‘Š

> è‡ªå‹•ç”Ÿæˆçš„ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥å ±å‘Š

**ç”Ÿæˆæ™‚é–“**: ${timestamp}

## ğŸ“Š æª¢æŸ¥æ‘˜è¦

| æª¢æŸ¥é¡å‹ | ç‹€æ…‹ | çµæœ |
|---------|------|------|
| TypeScript (ESLint) | ${tsResult.success ? 'âœ… é€šé' : 'âŒ ç™¼ç¾å•é¡Œ'} | ${tsErrors} |
| Style (Stylelint) | ${styleResult.success ? 'âœ… é€šé' : 'âŒ ç™¼ç¾å•é¡Œ'} | ${styleErrors} |

## ğŸ” è©³ç´°å ±å‘Š

### TypeScript Lint (ESLint)

${tsResult.success ? 'âœ… **ç„¡éŒ¯èª¤** - ç¨‹å¼ç¢¼ç¬¦åˆ ESLint è¦ç¯„' : ''}

\`\`\`
${tsResult.output.trim() || '(ç„¡è¼¸å‡º)'}
\`\`\`

### Style Lint (Stylelint)

${styleResult.success ? 'âœ… **ç„¡éŒ¯èª¤** - æ¨£å¼æª”æ¡ˆç¬¦åˆ Stylelint è¦ç¯„' : ''}

\`\`\`
${styleResult.output.trim() || '(ç„¡è¼¸å‡º)'}
\`\`\`

## ğŸ’¡ å»ºè­°ä¿®å¾©æ­¥é©Ÿ

### è‡ªå‹•ä¿®å¾©
\`\`\`bash
# è‡ªå‹•ä¿®å¾© TypeScript å•é¡Œ
yarn lint:ts

# è‡ªå‹•ä¿®å¾© Style å•é¡Œ
yarn lint:style
\`\`\`

### æ‰‹å‹•æª¢æŸ¥
å¦‚æœè‡ªå‹•ä¿®å¾©ç„¡æ³•è§£æ±ºæ‰€æœ‰å•é¡Œï¼Œè«‹ï¼š
1. æª¢æŸ¥ä¸Šè¿°è©³ç´°å ±å‘Šä¸­çš„éŒ¯èª¤è¨Šæ¯
2. æ ¹æ“š ESLint/Stylelint è¦å‰‡é€²è¡Œæ‰‹å‹•ä¿®æ­£
3. åƒè€ƒ Memory Bank ä¸­çš„ç¨‹å¼ç¢¼è¦ç¯„æ–‡ä»¶

## ğŸ“š ç›¸é—œæ–‡ä»¶

- [ç¨‹å¼ç¢¼è¦ç¯„](./implementation/code/codeStandards.md)
- [ESLint é…ç½®](../eslint.config.mjs)
- [Stylelint é…ç½®](../stylelint.config.mjs)

---

*Generated by ng-alain Structure Generator - Lint Report Module*
`;
}

function generateStyleLintMarkdown(styleResult: LintResult): string {
  const timestamp = new Date().toISOString().replace('T', ' ').substring(0, 19);
  const styleErrors = (styleResult.output.match(/âœ– \d+ problem/g) || [])[0] || 'ç„¡éŒ¯èª¤';

  return `# ğŸ¨ ng-alain Style Lint éŒ¯èª¤å ±å‘Š

> è‡ªå‹•ç”Ÿæˆçš„æ¨£å¼æª”æ¡ˆå“è³ªæª¢æŸ¥å ±å‘Šï¼ˆStylelintï¼‰

**ç”Ÿæˆæ™‚é–“**: ${timestamp}

## ğŸ“Š æª¢æŸ¥æ‘˜è¦

| æª¢æŸ¥é¡å‹ | ç‹€æ…‹ | çµæœ |
|---------|------|------|
| Style (Stylelint) | ${styleResult.success ? 'âœ… é€šé' : 'âŒ ç™¼ç¾å•é¡Œ'} | ${styleErrors} |

## ğŸ” è©³ç´°å ±å‘Š

### Stylelint æª¢æŸ¥çµæœ

${styleResult.success ? 'âœ… **ç„¡éŒ¯èª¤** - æ‰€æœ‰æ¨£å¼æª”æ¡ˆç¬¦åˆ Stylelint è¦ç¯„' : ''}

\`\`\`
${styleResult.output.trim() || '(ç„¡è¼¸å‡º)'}
\`\`\`

## ğŸ’¡ å»ºè­°ä¿®å¾©æ­¥é©Ÿ

### è‡ªå‹•ä¿®å¾©
\`\`\`bash
# è‡ªå‹•ä¿®å¾© Style å•é¡Œ
yarn lint:style
\`\`\`

### æ‰‹å‹•æª¢æŸ¥
å¦‚æœè‡ªå‹•ä¿®å¾©ç„¡æ³•è§£æ±ºæ‰€æœ‰å•é¡Œï¼Œè«‹ï¼š
1. æª¢æŸ¥ä¸Šè¿°è©³ç´°å ±å‘Šä¸­çš„éŒ¯èª¤è¨Šæ¯
2. æ ¹æ“š Stylelint è¦å‰‡é€²è¡Œæ‰‹å‹•ä¿®æ­£
3. åƒè€ƒ Memory Bank ä¸­çš„ç¨‹å¼ç¢¼è¦ç¯„æ–‡ä»¶

## ğŸ“š ç›¸é—œæ–‡ä»¶

- [ç¨‹å¼ç¢¼è¦ç¯„](./implementation/code/codeStandards.md)
- [Stylelint é…ç½®](../stylelint.config.mjs)

---

*Generated by ng-alain Structure Generator - Style Lint Report Module*
`;
}

function runLintAndSaveReport(): void {
  const outputPath = path.join(process.cwd(), 'memory-bank', 'ng-alain-lint-error.md');

  console.log('ğŸ” é–‹å§‹åŸ·è¡Œ Lint æª¢æŸ¥...\n');

  // åŸ·è¡Œ TypeScript Lint
  console.log('ğŸ“ åŸ·è¡Œ TypeScript Lint (ESLint)...');
  const tsResult: LintResult = { success: true, output: '', errors: '' };
  try {
    tsResult.output = execSync('yarn eslint --cache', { encoding: 'utf8', stdio: 'pipe' });
  } catch (error: unknown) {
    tsResult.success = false;
    const err = error as { stdout?: string; stderr?: string };
    tsResult.output = (err.stdout || '') + (err.stderr || '');
  }

  // åŸ·è¡Œ Style Lint
  console.log('ğŸ¨ åŸ·è¡Œ Style Lint (Stylelint)...');
  const styleResult: LintResult = { success: true, output: '', errors: '' };
  try {
    styleResult.output = execSync("yarn stylelint 'src/**/*.less'", { encoding: 'utf8', stdio: 'pipe' });
  } catch (error: unknown) {
    styleResult.success = false;
    const err = error as { stdout?: string; stderr?: string };
    styleResult.output = (err.stdout || '') + (err.stderr || '');
  }

  // ç”Ÿæˆä¸¦å¯«å…¥åˆä½µå ±å‘Š
  const report = generateLintMarkdown(tsResult, styleResult);
  fs.writeFileSync(outputPath, report, 'utf8');

  console.log(`âœ… Lint å ±å‘Šå·²ç”Ÿæˆ: ${outputPath}`);
  console.log(tsResult.success && styleResult.success ? '   âœ¨ æ‰€æœ‰æª¢æŸ¥é€šéï¼' : '   âš ï¸  ç™¼ç¾å•é¡Œï¼Œè«‹æŸ¥çœ‹å ±å‘Šè©³æƒ…');
  console.log('');

  // ç”Ÿæˆä¸¦å¯«å…¥ç¨ç«‹çš„ Style Lint å ±å‘Š
  const styleOutputPath = path.join(process.cwd(), 'memory-bank', 'ng-alain-lint-error-style.md');
  const styleReport = generateStyleLintMarkdown(styleResult);
  fs.writeFileSync(styleOutputPath, styleReport, 'utf8');

  console.log(`âœ… Style Lint ç¨ç«‹å ±å‘Šå·²ç”Ÿæˆ: ${styleOutputPath}`);
  console.log(styleResult.success ? '   âœ¨ Style æª¢æŸ¥é€šéï¼' : '   âš ï¸  ç™¼ç¾æ¨£å¼å•é¡Œï¼Œè«‹æŸ¥çœ‹å ±å‘Šè©³æƒ…');
  console.log('');
}

function generateProjectStructure(): void {
  const rootPath = process.cwd();
  const outputDir = path.join(rootPath, 'memory-bank');

  if (!fs.existsSync(outputDir)) {
    fs.mkdirSync(outputDir, { recursive: true });
  }

  console.log('ğŸ” é–‹å§‹ç”Ÿæˆå°ˆæ¡ˆçµæ§‹èˆ‡ Lint å ±å‘Š...\n');

  // 1. åŸ·è¡Œ Lint æª¢æŸ¥
  runLintAndSaveReport();

  // 2. ç”Ÿæˆè³‡æ–™å¤¾çµæ§‹ï¼ˆåªæœ‰ç›®éŒ„ï¼‰
  console.log('ğŸ“ ç”Ÿæˆè³‡æ–™å¤¾çµæ§‹...');
  const folderResult = generateTreeWithStats(rootPath, '', true, 0, 10, true);
  const folderContent = generateMarkdown(folderResult.tree, 'ğŸ“ ng-alain å°ˆæ¡ˆè³‡æ–™å¤¾çµæ§‹', 'åƒ…åŒ…å«ç›®éŒ„çµæ§‹ï¼Œä¸åŒ…å«æ–‡ä»¶', folderResult.stats);
  fs.writeFileSync(path.join(outputDir, 'ng-alain-structure-folders.md'), folderContent, 'utf8');
  console.log(`âœ… è³‡æ–™å¤¾çµæ§‹å·²ç”Ÿæˆ\n   ğŸ“Š ç›®éŒ„ç¸½æ•¸: ${folderResult.stats.folders}\n`);

  // 3. ç”Ÿæˆå®Œæ•´çµæ§‹ï¼ˆåŒ…å«æ–‡ä»¶ï¼‰
  console.log('ğŸ“„ ç”Ÿæˆå®Œæ•´çµæ§‹...');
  const fullResult = generateTreeWithStats(rootPath, '', true, 0, 10, false);
  const fullContent = generateMarkdown(fullResult.tree, 'ğŸ“„ ng-alain å°ˆæ¡ˆå®Œæ•´çµæ§‹', 'åŒ…å«å®Œæ•´çš„ç›®éŒ„å’Œæ–‡ä»¶çµæ§‹', fullResult.stats);
  fs.writeFileSync(path.join(outputDir, 'ng-alain-structure-full.md'), fullContent, 'utf8');
  console.log(`âœ… å®Œæ•´çµæ§‹å·²ç”Ÿæˆ\n   ğŸ“Š ç›®éŒ„ç¸½æ•¸: ${fullResult.stats.folders}\n   ğŸ“Š æ–‡ä»¶ç¸½æ•¸: ${fullResult.stats.files}\n`);

  console.log('ğŸ‰ å°ˆæ¡ˆçµæ§‹èˆ‡ Lint å ±å‘Šç”Ÿæˆå®Œæˆï¼');
}

// ============================================================
// åŸ·è¡Œè…³æœ¬
// ============================================================

if (require.main === module) {
  try {
    generateProjectStructure();
  } catch (error) {
    console.error('âŒ ç”Ÿæˆå°ˆæ¡ˆçµæ§‹æ™‚ç™¼ç”ŸéŒ¯èª¤:', (error as Error).message);
    process.exit(1);
  }
}

export { generateProjectStructure, generateTreeWithStats };
