# ç»„ç»‡åˆ‡æ¢å™¨è®¾è®¡å†³ç­–

**è®¾è®¡æ—¥æœŸ**: 2025-10-07  
**å¤æ‚åº¦**: Level 3ï¼ˆä¸­å‹åŠŸèƒ½ï¼‰  
**é¢„è®¡æ—¶é—´**: 4-6 å°æ—¶  
**çŠ¶æ€**: ğŸ“‹ è®¾è®¡å®Œæˆï¼Œå¾…å®æ–½

---

## ğŸ¯ è®¾è®¡ç›®æ ‡

å®ç°ç±»ä¼¼ Next.js org-switcher çš„åŠŸèƒ½ï¼Œå…è®¸ç”¨æˆ·åœ¨**ä¸ªäººç©ºé—´**å’Œ**ç»„ç»‡ç©ºé—´**ä¹‹é—´åˆ‡æ¢ï¼Œåˆ‡æ¢æ—¶åŠ¨æ€åŠ è½½ä¸åŒçš„èœå•ç»“æ„ï¼ŒåŒæ—¶å…¼å®¹ç°æœ‰çš„ **Tab å¤šé¡µç­¾ç³»ç»Ÿ**ã€‚

---

## ğŸ“Š æ ¸å¿ƒè®¾è®¡åŸåˆ™

### 1. **é›¶ç ´åæ€§åŸåˆ™** âœ…
- ä¸ä¿®æ”¹ç°æœ‰çš„ Tab ç³»ç»Ÿ
- ä¸ä¿®æ”¹ç°æœ‰çš„ MenuService ç”¨æ³•
- ä¸ä¿®æ”¹ç°æœ‰çš„å¸ƒå±€ç»“æ„
- ä»…æ·»åŠ æ–°ç»„ä»¶å’ŒæœåŠ¡

### 2. **Tab ç³»ç»Ÿå…¼å®¹** âœ…
- åˆ‡æ¢ç»„ç»‡æ—¶ä¿ç•™å½“å‰ Tab çŠ¶æ€ï¼ˆå¯é€‰ï¼‰
- æˆ–æ¸…é™¤æ‰€æœ‰ Tabï¼Œé‡æ–°å¼€å§‹ï¼ˆæ¨èï¼‰
- ä¸ SimpleReuseStrategy æ— å†²çª

### 3. **æ¸è¿›å¼å¢å¼º** âœ…
- é˜¶æ®µ 1ï¼šUI ç»„ä»¶ + åŸºç¡€åˆ‡æ¢
- é˜¶æ®µ 2ï¼šèœå•åŠ¨æ€åŠ è½½
- é˜¶æ®µ 3ï¼šTab é›†æˆä¼˜åŒ–

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### è§†è§‰å¸ƒå±€

```
ä¾§è¾¹æ å¸ƒå±€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ [Logo] æˆ‘çš„çµ„ç¹”    â–¼  â”‚ â”‚ â† ç»„ç»‡åˆ‡æ¢å™¨ï¼ˆæ–°å¢ï¼‰
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                            â”‚
â”‚ â€¢ Dashboard                â”‚
â”‚ â€¢ çµ„ç¹”ç®¡ç†                 â”‚ â† èœå•ï¼ˆåŠ¨æ€åŠ è½½ï¼‰
â”‚ â€¢ ...                      â”‚
â”‚                            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ [å¤´åƒ] Admin               â”‚ â† ç”¨æˆ·ä¿¡æ¯ï¼ˆåŸæœ‰ï¼‰
â”‚        admin@email.com     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   OrgSwitcherComponent (UI)         â”‚
â”‚   - ä¸‹æ‹‰èœå•                         â”‚
â”‚   - ç»„ç»‡åˆ—è¡¨                         â”‚
â”‚   - åˆ‡æ¢è§¦å‘                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ inject
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   OrganizationSwitcherService       â”‚
â”‚   - currentOrg: Signal              â”‚
â”‚   - organizations: Signal           â”‚
â”‚   - switchOrganization()            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ uses
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   @delon/theme Services             â”‚
â”‚   - MenuService (èœå•ç®¡ç†)           â”‚
â”‚   - ACLService (æƒé™ç®¡ç†)            â”‚
â”‚   - SettingsService (åº”ç”¨è®¾ç½®)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ æ–‡ä»¶æ¸…å•ä¸è®¾è®¡

### âœ¨ æ ¸å¿ƒæ–‡ä»¶ï¼ˆå¿…é¡»åˆ›å»ºï¼‰

#### 1. ç»„ç»‡åˆ‡æ¢å™¨æ•°æ®æ¨¡å‹

**æ–‡ä»¶**: `src/app/features/organization/models/organization.model.ts`

**ä¿®æ”¹**: åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ 

```typescript
/**
 * ç»„ç»‡åˆ‡æ¢å™¨æ•°æ®é¡¹
 * @description ç”¨äºç»„ç»‡åˆ‡æ¢å™¨çš„è½»é‡çº§æ•°æ®æ¨¡å‹
 */
export interface OrganizationSwitcherItem {
  /** ç»„ç»‡å”¯ä¸€è¯†åˆ«ç  */
  id: string;
  
  /** ç»„ç»‡åç§° */
  name: string;
  
  /** ç©ºé—´ç±»å‹ */
  type: 'personal' | 'organization';
  
  /** ç»„ç»‡ Logo URL */
  logo?: string;
  
  /** ç”¨æˆ·åœ¨æ­¤ç»„ç»‡çš„è§’è‰² */
  role?: 'owner' | 'admin' | 'member' | 'viewer';
}
```

---

#### 2. ç»„ç»‡åˆ‡æ¢æœåŠ¡

**æ–‡ä»¶**: `src/app/core/services/organization-switcher/organization-switcher.service.ts`ï¼ˆæ–°å»ºç›®å½•ï¼‰

**è®¾è®¡è¦ç‚¹**:
- âœ… ä½¿ç”¨ Angular Signals ç®¡ç†çŠ¶æ€
- âœ… providedIn: 'root' å•ä¾‹æœåŠ¡
- âœ… é›†æˆ MenuServiceã€ACLService
- âœ… localStorage æŒä¹…åŒ–å½“å‰é€‰æ‹©
- âœ… **ä¸ Tab ç³»ç»Ÿé›†æˆ**ï¼šåˆ‡æ¢æ—¶å¯é€‰æ¸…é™¤æ‰€æœ‰ Tab

```typescript
@Injectable({ providedIn: 'root' })
export class OrganizationSwitcherService {
  private readonly menuService = inject(MenuService);
  private readonly aclService = inject(ACLService);
  private readonly tabService = inject(TabService);  // â† é›†æˆ Tab æœåŠ¡
  private readonly http = inject(_HttpClient);
  private readonly router = inject(Router);
  private readonly message = inject(NzMessageService);
  
  // çŠ¶æ€ç®¡ç†ï¼ˆSignalsï¼‰
  private readonly _currentOrg = signal<OrganizationSwitcherItem | null>(null);
  readonly currentOrg = this._currentOrg.asReadonly();
  
  private readonly _organizations = signal<OrganizationSwitcherItem[]>([]);
  readonly organizations = this._organizations.asReadonly();
  
  /**
   * åˆ‡æ¢ç»„ç»‡
   * @param orgId ç›®æ ‡ç»„ç»‡ ID
   * @param clearTabs æ˜¯å¦æ¸…é™¤æ‰€æœ‰ Tabï¼ˆé»˜è®¤ trueï¼‰
   */
  switchOrganization(orgId: string, clearTabs = true): void {
    const targetOrg = this._organizations().find(o => o.id === orgId);
    if (!targetOrg || targetOrg.id === this._currentOrg()?.id) {
      return;
    }
    
    // 1. æ›´æ–°å½“å‰ç»„ç»‡
    this._currentOrg.set(targetOrg);
    localStorage.setItem('current_organization_id', orgId);
    
    // 2. æ¸…é™¤èœå•å’Œ Tabï¼ˆå¯é€‰ï¼‰
    this.menuService.clear();
    if (clearTabs) {
      this.tabService.clearTabs();  // â† æ¸…é™¤æ‰€æœ‰ Tab
    }
    
    // 3. åŠ è½½æ–°èœå•
    this.loadMenuForOrganization(orgId);
    
    // 4. å¯é€‰ï¼šæ›´æ–° ACL æƒé™
    // this.aclService.setFull(permissions);
    
    // 5. è·³è½¬åˆ°é¦–é¡µï¼ˆå¯é€‰ï¼‰
    this.router.navigateByUrl('/dashboard');
    
    this.message.success(`å·²åˆ‡æ›è‡³ ${targetOrg.name}`);
  }
}
```

**å…³é”®è®¾è®¡å†³ç­–**:
- âœ… `clearTabs` å‚æ•°ï¼šå…è®¸ä¿ç•™æˆ–æ¸…é™¤ Tab
- âœ… **æ¨èé»˜è®¤æ¸…é™¤ Tab**ï¼ˆé¿å…è·¨ç»„ç»‡çš„ Tab æ··ä¹±ï¼‰
- âœ… åˆ‡æ¢åè·³è½¬é¦–é¡µï¼ˆç”¨æˆ·ä½“éªŒæ›´å¥½ï¼‰

---

#### 3. ç»„ç»‡åˆ‡æ¢å™¨ UI ç»„ä»¶

**æ–‡ä»¶**: `src/app/layout/basic-layout/widgets/org-switcher.component.ts`ï¼ˆæ–°å»ºï¼‰

**è®¾è®¡è¦ç‚¹**:
- âœ… 100% Standalone Component
- âœ… OnPush å˜æ›´æ£€æµ‹ç­–ç•¥
- âœ… ä½¿ç”¨ ng-zorro dropdown + avatar
- âœ… ä½¿ç”¨ Signals å“åº”å¼çŠ¶æ€
- âœ… å®Œæ•´çš„æ ·å¼å’Œäº¤äº’

```typescript
@Component({
  selector: 'org-switcher',
  standalone: true,
  template: `
    <div class="org-switcher-wrapper" 
         nz-dropdown 
         [nzDropdownMenu]="orgMenu" 
         nzTrigger="click"
         nzPlacement="bottomLeft">
      <div class="org-switcher-trigger">
        <nz-avatar 
          [nzSrc]="currentOrg()?.logo" 
          [nzText]="currentOrg()?.name?.[0]" 
          nzSize="default" 
        />
        <div class="org-info">
          <strong class="org-name">{{ currentOrg()?.name }}</strong>
          <small class="org-type">
            {{ currentOrg()?.type === 'personal' ? 'å€‹äººç©ºé–“' : 'çµ„ç¹”' }}
          </small>
        </div>
        <i nz-icon nzType="swap" class="swap-icon"></i>
      </div>
    </div>
    
    <nz-dropdown-menu #orgMenu="nzDropdownMenu">
      <ul nz-menu class="org-switcher-menu">
        @for (org of organizations(); track org.id) {
          <li nz-menu-item 
              (click)="switchOrg(org)" 
              class="org-menu-item"
              [class.org-menu-item-selected]="org.id === currentOrg()?.id">
            <nz-avatar [nzSrc]="org.logo" [nzText]="org.name[0]" nzSize="small" />
            <span class="org-menu-name">{{ org.name }}</span>
            @if (org.id === currentOrg()?.id) {
              <i nz-icon nzType="check" class="check-icon"></i>
            }
          </li>
        }
        <li nz-menu-divider></li>
        <li nz-menu-item routerLink="/organization/new">
          <i nz-icon nzType="plus-circle"></i>
          <span>{{ 'org.switcher.create-new' | i18n }}</span>
        </li>
      </ul>
    </nz-dropdown-menu>
  `,
  styles: [`
    .org-switcher-wrapper {
      padding: 16px;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.3s;
    }
    .org-switcher-wrapper:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }
    .org-switcher-trigger {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .org-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    .org-name {
      font-size: 14px;
      font-weight: 500;
      color: rgba(0, 0, 0, 0.85);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .org-type {
      font-size: 12px;
      color: rgba(0, 0, 0, 0.45);
    }
    .swap-icon {
      color: rgba(0, 0, 0, 0.45);
      font-size: 12px;
    }
    .org-switcher-menu {
      min-width: 200px;
    }
    .org-menu-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .org-menu-name {
      flex: 1;
    }
    .check-icon {
      color: #1890ff;
      margin-left: auto;
    }
    .org-menu-item-selected {
      background-color: #e6f7ff;
    }
  `],
  changeDetection: ChangeDetectionStrategy.OnPush,
  imports: [
    NzDropDownModule, 
    NzMenuModule, 
    NzIconModule, 
    NzAvatarModule, 
    RouterLink, 
    I18nPipe
  ]
})
export class OrgSwitcherComponent {
  private readonly orgSwitcherService = inject(OrganizationSwitcherService);
  
  readonly currentOrg = this.orgSwitcherService.currentOrg;
  readonly organizations = this.orgSwitcherService.organizations;
  
  switchOrg(org: OrganizationSwitcherItem): void {
    this.orgSwitcherService.switchOrganization(org.id);
  }
}
```

---

#### 4. å¸ƒå±€é›†æˆ

**æ–‡ä»¶**: `src/app/layout/basic-layout/basic.component.ts`

**ä¿®æ”¹ä½ç½®**: 
1. imports æ•°ç»„æ·»åŠ  `OrgSwitcherComponent`
2. asideUserTpl æ¨¡æ¿æ·»åŠ  `<org-switcher>`

```typescript
// Line ~21: å¯¼å…¥ç»„ä»¶
import { OrgSwitcherComponent } from './widgets/org-switcher.component';

// Line ~83-96: ä¿®æ”¹ asideUserTpl æ¨¡æ¿
<ng-template #asideUserTpl>
  <!-- âœ¨ æ–°å¢ï¼šç»„ç»‡åˆ‡æ¢å™¨ -->
  <org-switcher class="mb-md" />
  
  <li nz-menu-divider></li>
  
  <!-- åŸæœ‰ï¼šç”¨æˆ·ä¿¡æ¯ -->
  <div nz-dropdown nzTrigger="click" [nzDropdownMenu]="userMenu" class="alain-default__aside-user">
    <nz-avatar class="alain-default__aside-user-avatar" [nzSrc]="user.avatar" />
    <div class="alain-default__aside-user-info">
      <strong>{{ user.name }}</strong>
      <p class="mb0">{{ user.email }}</p>
    </div>
  </div>
  <nz-dropdown-menu #userMenu="nzDropdownMenu">
    <ul nz-menu>
      <li nz-menu-item routerLink="/pro/account/center">{{ 'menu.account.center' | i18n }}</li>
      <li nz-menu-item routerLink="/pro/account/settings">{{ 'menu.account.settings' | i18n }}</li>
    </ul>
  </nz-dropdown-menu>
</ng-template>

// Line ~122: imports æ•°ç»„
imports: [
  // ... ç°æœ‰å¯¼å…¥ ...
  OrgSwitcherComponent  // â† æ–°å¢
]
```

---

#### 5. Startup Service åˆå§‹åŒ–

**æ–‡ä»¶**: `src/app/core/startup/startup.service.ts`

**ä¿®æ”¹ä½ç½®**: `load()` æ–¹æ³•ï¼ˆçº¦ line 49-64ï¼‰

```typescript
import { OrganizationSwitcherService } from '../services/organization-switcher/organization-switcher.service';

load(): Observable<void> {
  return zip(this.i18n.loadLangData(defaultLang), this.httpClient.get('./assets/tmp/app-data.json')).pipe(
    map(([langData, appData]: [Record<string, string>, NzSafeAny]) => {
      // ... ç°æœ‰ä»£ç  ...
      
      // âœ¨ æ–°å¢ï¼šåˆå§‹åŒ–ç»„ç»‡åˆ‡æ¢å™¨
      const orgSwitcherService = inject(OrganizationSwitcherService);
      if (appData.organizations) {
        orgSwitcherService.initialize(
          appData.organizations,
          appData.defaultOrganizationId || 'personal'
        );
      }
    })
  );
}
```

---

## ğŸ”„ Tab ç³»ç»Ÿé›†æˆç­–ç•¥

### ç­–ç•¥ Aï¼šåˆ‡æ¢ç»„ç»‡æ—¶æ¸…é™¤æ‰€æœ‰ Tabï¼ˆæ¨èï¼‰â­â­â­â­â­

**ç†ç”±**:
- âœ… é¿å…è·¨ç»„ç»‡ Tab æ··ä¹±
- âœ… ç”¨æˆ·ä½“éªŒæ›´æ¸…æ™°
- âœ… å®ç°ç®€å•

**å®ç°**:
```typescript
switchOrganization(orgId: string): void {
  // ...
  this.tabService.clearTabs();  // â† æ¸…é™¤æ‰€æœ‰ Tab
  this.router.navigateByUrl('/dashboard');  // è·³è½¬é¦–é¡µ
}
```

---

### ç­–ç•¥ Bï¼šä¿ç•™ Tabï¼Œä»…æ›´æ–°èœå•

**ç†ç”±**:
- âš ï¸ å¯èƒ½å¯¼è‡´ Tab å¯¹åº”çš„è·¯ç”±åœ¨æ–°ç»„ç»‡ä¸­æ— æƒé™è®¿é—®
- âš ï¸ å®ç°å¤æ‚ï¼Œéœ€è¦æƒé™æ£€æŸ¥

**å®ç°**:
```typescript
switchOrganization(orgId: string): void {
  // ...
  // ä¸æ¸…é™¤ Tabï¼Œä»…æ›´æ–°èœå•
  this.menuService.clear();
  this.menuService.add(newMenu);
  
  // æ£€æŸ¥å½“å‰è·¯ç”±æ˜¯å¦æœ‰æƒé™
  const hasPermission = this.checkCurrentRoutePermission();
  if (!hasPermission) {
    this.router.navigateByUrl('/dashboard');
  }
}
```

---

### ç­–ç•¥ Cï¼šæ™ºèƒ½ä¿ç•™ï¼ˆé«˜çº§ï¼‰

**ç†ç”±**:
- âœ… ä¿ç•™æœ‰æƒé™çš„ Tab
- âœ… å…³é—­æ— æƒé™çš„ Tab
- âš ï¸ å®ç°å¤æ‚

**å®ç°**:
```typescript
switchOrganization(orgId: string): void {
  // ...
  const currentTabs = this.tabService.getTabList();
  
  // è¿‡æ»¤æœ‰æƒé™çš„ Tab
  currentTabs.forEach(tab => {
    if (!this.hasPermissionForRoute(tab.url)) {
      this.tabService.closeTab(tab.url);
    }
  });
}
```

---

### ğŸ“‹ æ¨èæ–¹æ¡ˆ

**é‡‡ç”¨ç­–ç•¥ A**ï¼ˆæ¸…é™¤æ‰€æœ‰ Tabï¼‰

**åŸå› **:
1. âœ… æœ€ç®€å•ï¼Œæœ€å¯é 
2. âœ… ç”¨æˆ·ä½“éªŒæ¸…æ™°ï¼ˆæ˜ç¡®çŸ¥é“åˆ‡æ¢äº†ç»„ç»‡ï¼‰
3. âœ… é¿å…æƒé™é—®é¢˜
4. âœ… é¿å…è·¨ç»„ç»‡æ•°æ®æ··æ·†

**ç”¨æˆ·ä½“éªŒæµç¨‹**:
```
1. ç”¨æˆ·åœ¨"ç»„ç»‡ A"ä¸­æ‰“å¼€äº† 3 ä¸ª Tab
2. ç”¨æˆ·åˆ‡æ¢åˆ°"ä¸ªäººç©ºé—´"
3. æ‰€æœ‰ Tab æ¸…é™¤ï¼Œè‡ªåŠ¨è·³è½¬åˆ°ä¸ªäººç©ºé—´é¦–é¡µ
4. ç”¨æˆ·åœ¨æ–°ç©ºé—´ä¸­é‡æ–°æ‰“å¼€éœ€è¦çš„é¡µé¢
```

---

## ğŸ“¦ èœå•åŠ¨æ€åŠ è½½è®¾è®¡

### å¼€å‘é˜¶æ®µï¼šå‰ç«¯é…ç½®æ–¹å¼

**æ–‡ä»¶**: `src/assets/tmp/app-data.json`

```json
{
  "app": { ... },
  "user": { ... },
  "organizations": [
    {
      "id": "personal",
      "name": "å€‹äººç©ºé–“",
      "type": "personal",
      "logo": "./assets/tmp/img/avatar.svg"
    },
    {
      "id": "org-1",
      "name": "æˆ‘çš„çµ„ç¹”",
      "type": "organization",
      "logo": "./assets/logo.svg",
      "role": "owner"
    },
    {
      "id": "org-2",
      "name": "æŠ€è¡“éƒ¨é–€",
      "type": "organization",
      "logo": "./assets/logo.svg",
      "role": "admin"
    }
  ],
  "menus": {
    "personal": [
      {
        "text": "å€‹äººå°èˆª",
        "group": true,
        "children": [
          {
            "text": "å„€è¡¨æ¿",
            "icon": "anticon-dashboard",
            "link": "/dashboard"
          }
        ]
      }
    ],
    "org-1": [
      {
        "text": "çµ„ç¹”å°èˆª",
        "group": true,
        "children": [
          {
            "text": "å„€è¡¨æ¿",
            "icon": "anticon-dashboard",
            "link": "/dashboard"
          },
          {
            "text": "çµ„ç¹”ç®¡ç†",
            "icon": "anticon-team",
            "link": "/organization",
            "children": [
              {
                "text": "éƒ¨é–€ç®¡ç†",
                "link": "/organization/departments"
              },
              {
                "text": "å“¡å·¥ç®¡ç†",
                "link": "/organization/employees"
              },
              {
                "text": "è§’è‰²ç®¡ç†",
                "link": "/organization/roles"
              }
            ]
          }
        ]
      }
    ],
    "org-2": [
      // æŠ€æœ¯éƒ¨é—¨çš„èœå•é…ç½®...
    ]
  },
  "defaultOrganizationId": "personal"
}
```

**èœå•åŠ è½½é€»è¾‘**:
```typescript
private loadMenuForOrganization(orgId: string): void {
  this.http.get('./assets/tmp/app-data.json').subscribe((data: any) => {
    const menuData = data.menus?.[orgId] || data.menus?.['personal'] || [];
    this.menuService.clear();
    this.menuService.add(menuData);
  });
}
```

---

### ç”Ÿäº§é˜¶æ®µï¼šåç«¯ API æ–¹å¼ï¼ˆæœªæ¥ï¼‰

**API è®¾è®¡**:
```
GET /api/organizations/current/menu
Response: {
  menu: [...],           // è¯¥ç»„ç»‡çš„èœå•ç»“æ„
  permissions: [...],    // ACL æƒé™åˆ—è¡¨
  features: [...]        // å¯ç”¨çš„åŠŸèƒ½ç‰¹æ€§
}
```

**è¿ç§»æ—¶åªéœ€ä¿®æ”¹æœåŠ¡**:
```typescript
private loadMenuForOrganization(orgId: string): void {
  this.http.get(`/api/organizations/${orgId}/menu`).subscribe(data => {
    this.menuService.clear();
    this.menuService.add(data.menu);
    this.aclService.setFull(data.permissions);
  });
}
```

---

## ğŸ”§ å›½é™…åŒ–æ”¯æŒ

### ç¿»è¯‘ Key è®¾è®¡

```json
{
  "org.switcher.personal": "å€‹äººç©ºé–“",
  "org.switcher.organization": "çµ„ç¹”",
  "org.switcher.create-new": "æ–°å¢çµ„ç¹”",
  "org.switcher.switch": "åˆ‡æ›ç©ºé–“",
  "org.switcher.current": "ç•¶å‰ç©ºé–“",
  "org.switcher.role.owner": "æ“æœ‰è€…",
  "org.switcher.role.admin": "ç®¡ç†å“¡",
  "org.switcher.role.member": "æˆå“¡",
  "org.switcher.role.viewer": "è¨ªå®¢"
}
```

### éœ€è¦æ›´æ–°çš„è¯­è¨€æ–‡ä»¶

- src/assets/tmp/i18n/zh-TW.json
- src/assets/tmp/i18n/zh-CN.json
- src/assets/tmp/i18n/en-US.json
- ... å…¶ä»– 9 ç§è¯­è¨€

---

## ğŸ¯ å®æ–½æ­¥éª¤ï¼ˆè¯¦ç»†ï¼‰

### é˜¶æ®µ 1ï¼šæ ¸å¿ƒåŠŸèƒ½ï¼ˆ3-4 å°æ—¶ï¼‰

#### Step 1.1ï¼šæ‰©å±•æ•°æ®æ¨¡å‹ï¼ˆ15 åˆ†é’Ÿï¼‰
```bash
# ç¼–è¾‘æ–‡ä»¶
src/app/features/organization/models/organization.model.ts
# åœ¨æœ«å°¾æ·»åŠ  OrganizationSwitcherItem æ¥å£
```

#### Step 1.2ï¼šåˆ›å»ºç»„ç»‡åˆ‡æ¢æœåŠ¡ï¼ˆ1 å°æ—¶ï¼‰
```bash
# åˆ›å»ºç›®å½•
mkdir src/app/core/services/organization-switcher

# åˆ›å»ºæœåŠ¡æ–‡ä»¶
# src/app/core/services/organization-switcher/organization-switcher.service.ts
# å®ç°å®Œæ•´çš„æœåŠ¡é€»è¾‘
```

#### Step 1.3ï¼šåˆ›å»ºç»„ç»‡åˆ‡æ¢å™¨ç»„ä»¶ï¼ˆ1.5 å°æ—¶ï¼‰
```bash
# åˆ›å»ºç»„ä»¶æ–‡ä»¶
# src/app/layout/basic-layout/widgets/org-switcher.component.ts
# å®ç° UI å’Œäº¤äº’é€»è¾‘
```

#### Step 1.4ï¼šé›†æˆåˆ°å¸ƒå±€ï¼ˆ30 åˆ†é’Ÿï¼‰
```bash
# ä¿®æ”¹ basic.component.ts
# 1. å¯¼å…¥ OrgSwitcherComponent
# 2. æ·»åŠ åˆ° imports æ•°ç»„
# 3. åœ¨ asideUserTpl ä¸­æ·»åŠ  <org-switcher>
```

#### Step 1.5ï¼šå‡†å¤‡ Mock æ•°æ®ï¼ˆ30 åˆ†é’Ÿï¼‰
```bash
# ä¿®æ”¹ app-data.json
# æ·»åŠ  organizations å’Œ menus é…ç½®
```

#### Step 1.6ï¼šæ›´æ–° core/index.tsï¼ˆ5 åˆ†é’Ÿï¼‰
```bash
# æ·»åŠ  OrganizationSwitcherService å¯¼å‡º
```

#### Step 1.7ï¼šä¿®æ”¹ startup.serviceï¼ˆ15 åˆ†é’Ÿï¼‰
```bash
# åœ¨ load() ä¸­åˆå§‹åŒ–ç»„ç»‡åˆ‡æ¢å™¨
```

#### Step 1.8ï¼šæµ‹è¯•åŸºæœ¬åŠŸèƒ½ï¼ˆ30 åˆ†é’Ÿï¼‰
```bash
npm start
# æµ‹è¯•åˆ‡æ¢åŠŸèƒ½ã€èœå•æ›´æ–°ã€Tab æ¸…é™¤
```

---

### é˜¶æ®µ 2ï¼šå›½é™…åŒ–å’Œæ ·å¼ï¼ˆ1 å°æ—¶ï¼‰

#### Step 2.1ï¼šæ·»åŠ ç¿»è¯‘ï¼ˆ30 åˆ†é’Ÿï¼‰
```bash
# æ›´æ–° 12 ç§è¯­è¨€æ–‡ä»¶
# æ·»åŠ  org.switcher.* ç¿»è¯‘
```

#### Step 2.2ï¼šæ ·å¼ä¼˜åŒ–ï¼ˆ30 åˆ†é’Ÿï¼‰
```bash
# ä¼˜åŒ– hover æ•ˆæœ
# æ·»åŠ åˆ‡æ¢åŠ¨ç”»
# å“åº”å¼é€‚é…
```

---

### é˜¶æ®µ 3ï¼šæµ‹è¯•å’Œæ–‡æ¡£ï¼ˆ1 å°æ—¶ï¼‰

#### Step 3.1ï¼šåŠŸèƒ½æµ‹è¯•ï¼ˆ30 åˆ†é’Ÿï¼‰
- [ ] ç»„ç»‡åˆ—è¡¨æ­£ç¡®æ˜¾ç¤º
- [ ] åˆ‡æ¢åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] èœå•åŠ¨æ€æ›´æ–°
- [ ] Tab æ­£ç¡®æ¸…é™¤
- [ ] localStorage æŒä¹…åŒ–
- [ ] åˆ·æ–°é¡µé¢åæ¢å¤

#### Step 3.2ï¼šç¼–å†™æ–‡æ¡£ï¼ˆ30 åˆ†é’Ÿï¼‰
- [ ] åˆ›å»ºä½¿ç”¨æŒ‡å—
- [ ] æ›´æ–° README
- [ ] æ·»åŠ  JSDoc æ³¨é‡Š

---

## ğŸ” Tab ç³»ç»Ÿå…¼å®¹æ€§éªŒè¯

### æµ‹è¯•åœºæ™¯

#### åœºæ™¯ 1ï¼šåˆ‡æ¢ç»„ç»‡æ¸…é™¤ Tab
```
1. åœ¨ç»„ç»‡ A ä¸­æ‰“å¼€ 3 ä¸ª Tabï¼ˆéƒ¨é—¨ã€å‘˜å·¥ã€è§’è‰²ï¼‰
2. åˆ‡æ¢åˆ°ä¸ªäººç©ºé—´
3. éªŒè¯ï¼šâœ… æ‰€æœ‰ Tab è¢«æ¸…é™¤
4. éªŒè¯ï¼šâœ… è‡ªåŠ¨è·³è½¬åˆ°ä¸ªäººç©ºé—´é¦–é¡µ
5. éªŒè¯ï¼šâœ… èœå•æ›´æ–°ä¸ºä¸ªäººç©ºé—´èœå•
```

#### åœºæ™¯ 2ï¼šåŒç»„ç»‡å†…å¯¼èˆª
```
1. åœ¨ç»„ç»‡ A ä¸­æ‰“å¼€ 3 ä¸ª Tab
2. ä¸åˆ‡æ¢ç»„ç»‡ï¼Œæ­£å¸¸å¯¼èˆª
3. éªŒè¯ï¼šâœ… Tab ç³»ç»Ÿæ­£å¸¸å·¥ä½œ
4. éªŒè¯ï¼šâœ… ç»„ä»¶çŠ¶æ€ä¿å­˜
5. éªŒè¯ï¼šâœ… æ»šåŠ¨ä½ç½®è®°å¿†
```

#### åœºæ™¯ 3ï¼šåˆ·æ–°é¡µé¢åæ¢å¤
```
1. åˆ‡æ¢åˆ°ç»„ç»‡ A
2. æ‰“å¼€ 2 ä¸ª Tab
3. åˆ·æ–°é¡µé¢ï¼ˆF5ï¼‰
4. éªŒè¯ï¼šâœ… ç»„ç»‡çŠ¶æ€æ¢å¤ï¼ˆä» localStorageï¼‰
5. éªŒè¯ï¼šâœ… Tab çŠ¶æ€æ¢å¤ï¼ˆSimpleReuseStrategyï¼‰
6. éªŒè¯ï¼šâœ… èœå•æ­£ç¡®åŠ è½½
```

---

## âš™ï¸ é«˜çº§åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰

### 1. HTTP Interceptor è‡ªåŠ¨æ·»åŠ ç»„ç»‡ ID

**æ–‡ä»¶**: `src/app/core/net/default.interceptor.ts`

**ä¿®æ”¹ä½ç½®**: `handleData` å‡½æ•°

```typescript
function handleData(injector: Injector, ev: HttpResponseBase, req: HttpRequest<any>, next: HttpHandlerFn): Observable<any> {
  // è·å–å½“å‰ç»„ç»‡
  const orgSwitcherService = injector.get(OrganizationSwitcherService);
  const currentOrg = orgSwitcherService.currentOrg();
  
  // ä¸ºç»„ç»‡ç©ºé—´çš„è¯·æ±‚æ·»åŠ ç»„ç»‡ ID å¤´
  if (currentOrg && currentOrg.type === 'organization') {
    req = req.clone({
      setHeaders: {
        'X-Organization-Id': currentOrg.id
      }
    });
  }
  
  // ... åŸæœ‰é€»è¾‘ ...
}
```

---

### 2. è·¯ç”±å®ˆå«é›†æˆ

**æ–‡ä»¶**: `src/app/features/organization/guards/organization.guard.ts`

**å¢å¼º**: æ£€æŸ¥å½“å‰ç»„ç»‡ç±»å‹

```typescript
export const organizationGuard: CanActivateFn = (route, state) => {
  const orgSwitcherService = inject(OrganizationSwitcherService);
  const currentOrg = orgSwitcherService.currentOrg();
  
  // åªæœ‰åœ¨ç»„ç»‡ç©ºé—´ä¸­æ‰èƒ½è®¿é—®ç»„ç»‡ç®¡ç†
  if (!currentOrg || currentOrg.type !== 'organization') {
    const notification = inject(NzNotificationService);
    const router = inject(Router);
    
    notification.warning('æç¤º', 'è«‹å…ˆåˆ‡æ›åˆ°çµ„ç¹”ç©ºé–“');
    router.navigate(['/dashboard']);
    return false;
  }
  
  // ... åŸæœ‰æƒé™æ£€æŸ¥ ...
};
```

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### ç”¨æˆ·ä½“éªŒæµç¨‹

```
1. ç”¨æˆ·ç™»å½• â†’ é»˜è®¤è¿›å…¥"ä¸ªäººç©ºé—´"
2. çœ‹åˆ°ä¾§è¾¹æ é¡¶éƒ¨æ˜¾ç¤º"å€‹äººç©ºé–“"
3. èœå•ä»…æ˜¾ç¤ºï¼šDashboard

4. ç‚¹å‡»ç»„ç»‡åˆ‡æ¢å™¨ â†’ çœ‹åˆ°ä¸‹æ‹‰èœå•
5. é€‰æ‹©"æˆ‘çš„çµ„ç¹”" â†’ åˆ‡æ¢æˆåŠŸ
6. æ‰€æœ‰ Tab æ¸…é™¤ï¼Œè·³è½¬åˆ° Dashboard
7. èœå•æ›´æ–°æ˜¾ç¤ºï¼šDashboard + çµ„ç¹”ç®¡ç†

8. æ‰“å¼€"éƒ¨é–€ç®¡ç†"ã€"å“¡å·¥ç®¡ç†" â†’ åˆ›å»º 2 ä¸ª Tab
9. åˆ‡æ¢å›"å€‹äººç©ºé–“" â†’ Tab æ¸…é™¤ï¼Œèœå•ç®€åŒ–

10. åˆ·æ–°é¡µé¢ â†’ ç»„ç»‡çŠ¶æ€æ¢å¤åˆ°"å€‹äººç©ºé–“"
```

---

## ğŸŠ è®¾è®¡ä¼˜åŠ¿

### 1. é›¶ç ´åæ€§ âœ…
- ä¸ä¿®æ”¹ä»»ä½•ç°æœ‰ç»„ä»¶
- ä¸å½±å“ Tab ç³»ç»Ÿæ ¸å¿ƒé€»è¾‘
- ä»…æ·»åŠ æ–°åŠŸèƒ½

### 2. å®Œç¾é›†æˆ âœ…
- ä¸ Tab ç³»ç»Ÿå…¼å®¹
- ä¸ MenuService é›†æˆ
- ä¸ ACLService é›†æˆ
- ä¸ LayoutDefaultModule é›†æˆ

### 3. æ¸è¿›å¼å®ç° âœ…
- é˜¶æ®µ 1ï¼šåŸºç¡€ UI + åˆ‡æ¢åŠŸèƒ½
- é˜¶æ®µ 2ï¼šèœå•åŠ¨æ€åŠ è½½
- é˜¶æ®µ 3ï¼šåç«¯ API é›†æˆ

### 4. å¯æ‰©å±•æ€§ âœ…
- æ”¯æŒæ— é™ç»„ç»‡
- æ”¯æŒç»„ç»‡å±‚çº§
- æ”¯æŒè§’è‰²æƒé™
- æ”¯æŒç‰¹æ€§å¼€å…³

---

## ğŸ“ æŠ€æœ¯è§„æ ¼

### ä¾èµ–æ¸…å•

**é›¶æ–°å¢ä¾èµ–** âœ…

ä½¿ç”¨ç°æœ‰ä¾èµ–ï¼š
- @delon/theme (MenuService, SettingsService, _HttpClient)
- @delon/acl (ACLService)
- ng-zorro-antd (dropdown, menu, avatar, icon)
- @angular/core (Signals, inject)

### å…¼å®¹æ€§

- âœ… Angular 20.3.0
- âœ… ng-alain 20.0.2
- âœ… ng-zorro-antd 20.3.1
- âœ… Tab ç³»ç»Ÿï¼ˆPhase 3 å·²å®Œæˆï¼‰
- âœ… æ‰€æœ‰ç°æœ‰åŠŸèƒ½

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [Tab ç³»ç»Ÿä½¿ç”¨æŒ‡å—](../context/tab-system-guide.md)
- [Organization æ¨¡å—è®¾è®¡](../../../src/app/features/organization/DESIGN.md)
- [ng-alain æ¶æ„æ–‡æ¡£](../../system-patterns/architecture/projectArchitecture.md)
- [æ¦¨å–æœ€ç»ˆæ€»ç»“](../context/extraction-final-summary.md)

---

## âœ… è®¾è®¡æ£€æŸ¥æ¸…å•

### æ¶æ„æ£€æŸ¥
- [x] ä¸ç ´åç°æœ‰ç»“æ„
- [x] ä¸ Tab ç³»ç»Ÿå…¼å®¹
- [x] ä½¿ç”¨ Angular æœ€ä½³å®è·µ
- [x] ä½¿ç”¨ ng-alain æ ‡å‡†æœåŠ¡
- [x] é›¶æ–°å¢å¤–éƒ¨ä¾èµ–

### åŠŸèƒ½æ£€æŸ¥
- [x] ç»„ç»‡åˆ—è¡¨æ˜¾ç¤º
- [x] ç»„ç»‡åˆ‡æ¢åŠŸèƒ½
- [x] èœå•åŠ¨æ€æ›´æ–°
- [x] Tab æ¸…é™¤é€»è¾‘
- [x] localStorage æŒä¹…åŒ–
- [x] åˆ·æ–°æ¢å¤çŠ¶æ€

### ä½“éªŒæ£€æŸ¥
- [x] UI ä¸ç°æœ‰é£æ ¼ä¸€è‡´
- [x] å“åº”å¼è®¾è®¡
- [x] å›½é™…åŒ–æ”¯æŒ
- [x] æ— éšœç¢æ”¯æŒ
- [x] å¹³æ»‘åŠ¨ç”»

---

**è®¾è®¡çŠ¶æ€**: âœ… å®Œæˆ  
**å®æ–½å‡†å¤‡**: âœ… å°±ç»ª  
**é¢„è®¡å·¥æ—¶**: 4-6 å°æ—¶  
**ä¸‹ä¸€æ­¥**: å¼€å§‹å®æ–½

